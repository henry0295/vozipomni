;============================================================================
; VoziPOmni Contact Center - Extensions Configuration
;============================================================================

[globals]
; Variables globales

[general]
static=yes
writeprotect=no
clearglobalvars=no

; Incluir dialplan dinámico generado por el backend
#include /var/lib/asterisk/dynamic/extensions_dynamic.conf

[from-internal]
; Contexto para agentes internos
exten => _1XXX,1,NoOp(Llamada interna a ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},30)
 same => n,Hangup()

; IVR Principal
exten => 9000,1,NoOp(IVR Principal)
 same => n,Answer()
 same => n,Playback(welcome)
 same => n,Background(main-menu)
 same => n,WaitExten(5)
 same => n,Goto(timeout,1)

exten => 1,1,Goto(queue-sales,s,1)
exten => 2,1,Goto(queue-support,s,1)
exten => 9,1,Goto(operator,s,1)

exten => timeout,1,Playback(vm-goodbye)
 same => n,Hangup()

exten => invalid,1,Playback(invalid)
 same => n,Goto(9000,2)

[from-external]
; Contexto para llamadas externas (legacy)
exten => _X.,1,NoOp(Llamada externa desde ${CALLERID(num)})
 same => n,Set(CALLERID(name)=External)
 same => n,Goto(from-pstn,${EXTEN},1)

;============================================================================
; CONTEXTO FROM-PSTN - Llamadas entrantes desde troncales PSTN/ITSP
; OmniLeads: Las llamadas de la PSTN entran por este contexto
; Las rutas entrantes (DIDs) se configuran desde la interfaz web
;============================================================================
[from-pstn]
; Las llamadas entrantes buscan primero una ruta DID configurada
; Si no hay DID configurado, van al IVR principal
exten => _X.,1,NoOp(Llamada PSTN entrante: ${CALLERID(num)} -> ${EXTEN})
 same => n,Set(CALLERID(name)=${CALLERID(num)})
 same => n,Set(__TRUNK_NAME=${CHANNEL(pjsip,endpoint)})
 same => n,MixMonitor(${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}-${CALLERID(num)}-${EXTEN}.wav,ab)
 same => n,AGI(agi://localhost:4573/inbound_route)
 same => n,Goto(from-internal,9000,1)
 same => n,Hangup()

; Extensión especial para cuando no hay match
exten => s,1,NoOp(Llamada PSTN sin DID)
 same => n,Goto(from-internal,9000,1)

;============================================================================
; CONTEXTO FROM-PBX - Llamadas entrantes desde PBX en LAN
; OmniLeads: Las llamadas desde una PBX corporativa entran aquí
; Permite contactar directamente a agentes (no solo campañas)
;============================================================================
[from-pbx]
; Llamadas desde PBX pueden ir directamente a extensiones de agentes
exten => _1XXX,1,NoOp(Llamada PBX a agente ${EXTEN})
 same => n,Set(CALLERID(name)=PBX-${CALLERID(num)})
 same => n,MixMonitor(${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}-${CALLERID(num)}-${EXTEN}.wav,ab)
 same => n,Dial(PJSIP/${EXTEN},30,tr)
 same => n,VoiceMail(${EXTEN}@default,u)
 same => n,Hangup()

; Llamadas PBX que no son a extensiones, ir al enrutamiento PSTN
exten => _X.,1,NoOp(Llamada PBX entrante: ${CALLERID(num)} -> ${EXTEN})
 same => n,Set(CALLERID(name)=PBX-${CALLERID(num)})
 same => n,MixMonitor(${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}-${CALLERID(num)}-${EXTEN}.wav,ab)
 same => n,AGI(agi://localhost:4573/inbound_route)
 same => n,Goto(from-internal,9000,1)
 same => n,Hangup()

;============================================================================
; CONTEXTO FROM-TRUNK - Contexto genérico para otras troncales
;============================================================================
[from-trunk]
exten => _X.,1,Goto(from-pstn,${EXTEN},1)

[queue-sales]
exten => s,1,NoOp(Cola de Ventas)
 same => n,Answer()
 same => n,Queue(sales,t,,,300)
 same => n,Hangup()

[queue-support]
exten => s,1,NoOp(Cola de Soporte)
 same => n,Answer()
 same => n,Queue(support,t,,,300)
 same => n,Hangup()

[operator]
exten => s,1,NoOp(Operador)
 same => n,Dial(PJSIP/1000,30)
 same => n,Hangup()

;============================================================================
; CONFIGURACIÓN DINÁMICA
; Generada automáticamente desde la interfaz web de VozipOmni
; Incluye extensiones, rutas entrantes/salientes e IVRs dinámicos
;============================================================================
#include extensions_dynamic.conf
